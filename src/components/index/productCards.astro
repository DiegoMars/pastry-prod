---
import { getCollection } from "astro:content";
// import { Image } from "astro:assets";

const products = await getCollection("products");

const currency = new Intl.NumberFormat("en-US", {
  style: "currency",
  currency: "USD",
});
---

<section class="px-4 py-12">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-center text-3xl md:text-4xl font-bold text-text mb-10">
      Our Treats
    </h2>

    {products.length === 0 && (
      <p class="text-center text-text-700">
        (No products yet â€“ add JSON files in <code>src/collections/products</code>.)
      </p>
    )}

    {products.length > 0 && (
      <div class="grid gap-10 sm:grid-cols-2 lg:grid-cols-3">
        {products.map(({ id, data }) => {
          const inStock =
            typeof data.stock === "number" ? data.stock > 0 : data.inStock ?? true;

          return (
           <a href={`#${data.title}`} id={data.title} class="flex flex-col content-center gap-[0.9rem] p-[0.25rem]">

              <!-- BLOB SHAPE IMAGE -->
              <div class="blobShape">
                {data.image && (
                  <img
                    src={data.image}
                    alt={data.imageAlt ?? data.title}
                    class="h-full w-full object-cover"
                    loading="lazy"
                  />
                )}
              </div>

              <!-- TEXT AREA -->
              <div class="text-center max-w-[18rem]">
                <h3 class="font-fancy2 text-xl md:text-2xl text-text-700">
                  {data.title}
                </h3>

                {data.description && (
                  <p class="text-sm text-text-600 mt-1">
                    {data.description}
                  </p>
                )}

                <div class="flex flex-col gap-[0.3rem] text-center mt-[0.6rem]">
                  <span class="priceRibbon">
                    {currency.format(data.price)}
                  </span>

                  <span class={`text-[0.75rem] uppercase ${inStock ? "text-primary-700" : "text-accent-700"}`}>
                    {inStock
                      ? (typeof data.stock === "number"
                          ? `In stock (${data.stock})`
                          : "In stock")
                      : "Sold out"}
                  </span>
                </div>
              </div>
            </a>
          );
        })}
      </div>
    )}
  </div>
</section>

<style>
  section {
    background:
      url("/stars-bg.svg") repeat,
      linear-gradient(
        to bottom,
        var(--color-background-50),
        var(--color-background-100),
        var(--color-background-200)
      );
    background-size:
      180px 180px,
      auto;
    background-blend-mode:
      normal,
      normal;

    color: var(--color-text);
    font-family: "Georgia", "Times New Roman", serif;
  }

  .blobShape {
    width: 100%;
    max-width: 18rem;
    aspect-ratio: 4 / 3;
    border-radius: 40% 60% 45% 55% / 55% 40% 60% 45%;
    background: var(--color-accent-50);
    padding: 0.3rem;
    position: relative;
    overflow: hidden;
    border: 2px solid var(--color-accent-300);
  }
  .blobShape img {
    border-radius: inherit;
  }

  .priceRibbon {
    position: relative;
    display: inline-block;
    padding: 0.45rem 1.4rem;
    background: var(--color-primary-200);
    color: var(--color-text-900);
    font-weight: 700;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    clip-path: polygon(
      0 0,
      90% 0,
      100% 50%,
      90% 100%,
      0 100%,
      5% 50%
    );
    border: 2px solid var(--color-primary-400);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const links = document.querySelectorAll('a[href^="#"]'); // Select all anchor links with hash
    links.forEach(link => {
      link.addEventListener('click', function(event) {
        event.preventDefault(); // Prevent default jump to top of element

        const targetId = this.getAttribute('href').substring(1); // Get target ID
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          // Calculate the scroll position to center the element
          const offsetTop = targetElement.getBoundingClientRect().top + window.scrollY;
          const windowHeight = window.innerHeight;
          const elementHeight = targetElement.offsetHeight;
          const scrollPosition = offsetTop - (windowHeight / 2) + (elementHeight / 2);

          window.scrollTo({
            top: scrollPosition,
            behavior: 'smooth' // For a smooth scrolling effect
          });
        }
      });
    });
  });
</script>
